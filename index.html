<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutrification - Health is your real wealth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2196F3; /* Default Neutral Blue */
            --primary-gradient: linear-gradient(45deg, #2196F3, #64B5F6);
            --background-color: #FFFFFF; /* Default White */
            --card-background-color: white;
            --text-color-primary: #111827;
            --text-color-secondary: #4b5563;
            --ring-color: #2563eb;
        }
        .dark {
             --primary-color: #64B5F6;
             --primary-gradient: linear-gradient(45deg, #64B5F6, #90CAF9);
             --background-color: #121212;
             --card-background-color: #1e293b;
             --text-color-primary: #f1f5f9;
             --text-color-secondary: #9ca3af;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color-primary);
            transition: background-color 0.5s ease;
        }
        .card {
            background-color: var(--card-background-color);
            border-radius: 1rem;
            box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.08);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: background-color 0.5s ease, box-shadow 0.2s ease, transform 0.2s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px -4px rgba(0, 0, 0, 0.1);
        }
        .card h2, .card h3 { color: var(--text-color-primary); font-weight: 700; }
        input, select, textarea {
            background-color: #f9fafb !important; color: #111827 !important;
            border-radius: 0.5rem; border: 1px solid #d1d5db; padding: 0.75rem 1rem; width: 100%;
            transition: box-shadow 0.2s ease;
        }
        input:focus, select:focus, textarea:focus {
            box-shadow: 0 0 0 2px var(--primary-color);
            outline: none;
        }
        .dark input, .dark select, .dark textarea {
            background-color: #334155 !important; border-color: #475569 !important; color: #f1f5f9 !important;
        }
        
        .heatmap-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .heatmap-cell { width: 100%; aspect-ratio: 1 / 1; border-radius: 8px; display: flex; align-items: flex-start; justify-content: flex-start; padding-top: 2px; padding-left: 4px; cursor: pointer; transition: transform 0.2s ease-in-out; }
        .heatmap-cell:hover { transform: scale(1.1) rotate(-2deg); }
        .heatmap-cell.current-day { box-shadow: 0 0 0 2px var(--ring-color); }
        .heatmap-day-number { font-size: 0.7rem; font-weight: 500; color: var(--text-color-secondary); }
        .heatmap-legend { display: flex; justify-content: center; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; font-size: 0.8rem; }
        .legend-item { display: flex; align-items: center; gap: 0.4rem; }
        .legend-color-box { width: 15px; height: 15px; border-radius: 4px; }

        .btn { font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; cursor: pointer; transition: all 0.2s ease-in-out; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .btn-primary { background: var(--primary-gradient); color: white; }
        .btn-primary:hover { filter: brightness(110%); }
        .btn-secondary { background-color: #e5e7eb; color: #1f2937; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--card-background-color); padding: 1.5rem; border-radius: 1rem; width: 90%; max-width: 500px; transform: scale(0.9); transition: transform 0.3s, background-color 0.5s ease; position: relative; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .close-btn { position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; line-height: 1; border: none; background: transparent; cursor: pointer; color: #6b7280; }
        .dark .close-btn { color: #9ca3af; }

        /* FAB */
        .fab {
            position: fixed; bottom: 2rem; right: 2rem;
            width: 4rem; height: 4rem;
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; line-height: 1;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer; transition: transform 0.2s, background 0.5s ease, box-shadow 0.2s ease;
            z-index: 40;
        }
        .fab:hover { transform: scale(1.1) rotate(90deg); box-shadow: 0 8px 16px rgba(0,0,0,0.3); }

        /* Circular Progress */
        .progress-circle-container {
            position: relative;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }
        .progress-circle { width: 100%; height: 100%; }
        .progress-circle-bar { transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 0.5s ease; }
        
        /* Badges */
        .badge { opacity: 0.3; filter: grayscale(1); transition: all 0.3s; }
        .badge.unlocked { opacity: 1; filter: grayscale(0); }
        .badge-icon { font-size: 3rem; }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-image: var(--primary-gradient); }
        input:checked + .slider:before { transform: translateX(26px); }
        
        .progress-container { background-color: #e5e7eb; border-radius: 9999px; height: 8px; width: 100%; overflow: hidden; margin-top: 4px; }
        .dark .progress-container { background-color: #374151; }
        .progress-bar { height: 100%; border-radius: 9999px; transition: width 0.3s ease-in-out; }

        #micros-modal-content::-webkit-scrollbar { width: 8px; }
        #micros-modal-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .dark #micros-modal-content::-webkit-scrollbar-track { background: #374151; }
        #micros-modal-content::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        #micros-modal-content::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .glass { cursor: pointer; transition: transform 0.2s; }
        .glass:hover { transform: scale(1.1); }
        .glass .glass-outline { fill: none; stroke: #d1d5db; stroke-width: 0.5; }
        .glass .water-fill { fill: #3b82f6; transform: translateY(100%); transition: transform 0.5s ease-in-out; }
        .glass.filled .water-fill { transform: translateY(0%); }
        
        #app-title {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }
    </style>
</head>
<body class="p-4">

    <div id="app-container" class="max-w-7xl mx-auto">
        <!-- Main Dashboard View -->
        <div id="main-dashboard">
             <header class="text-center mb-6 relative">
                <div class="flex items-center justify-center">
                    <h1 id="app-title" class="text-4xl sm:text-5xl">Nutrification</h1>
                </div>
                <p id="app-tagline" class="text-sm" style="color: var(--text-color-secondary);">Health is your real wealth</p>
                <button id="open-settings-page-btn" class="absolute top-0 right-0 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
            </header>

            <div class="card !p-4 mb-6">
                <h2 id="greeting" class="text-xl font-bold"></h2>
                <p id="insight-message" class="text-sm" style="color: var(--text-color-secondary);"></p>
            </div>

            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl" data-translate="summaryTitle">Today's Nutrition Summary</h2>
                    <button id="view-micros-btn" class="btn btn-primary !py-1 !px-3 text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1 11a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3h1V7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7h1V2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12h.5a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1H1v-3Z"/></svg>
                        <span data-translate="viewMicrosButton">Micronutrients</span>
                    </button>
                </div>
                <div id="circular-totals-display" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <!-- Circular progress bars will be injected here -->
                </div>
            </div>
             <div class="card">
                <h2 class="text-xl mb-3" data-translate="hydrationTitle">Today's Hydration</h2>
                <div id="water-tracker" class="flex justify-center items-center gap-2 text-4xl">
                    <!-- Water glasses will be injected here -->
                </div>
                <p id="water-counter" class="text-center text-sm mt-3" style="color: var(--text-color-secondary);"></p>
            </div>
            <div class="card">
                <h2 class="text-xl mb-3" data-translate="logFoodTitle">Log Food for Today</h2>
                 <form id="log-food-form" class="flex flex-col sm:flex-row items-center gap-3">
                    <select id="food-select" class="flex-grow" required><option value="" data-translate="selectFoodOption">-- Select a food --</option></select>
                    <input type="number" id="log-quantity" value="1" min="0.1" step="0.1" class="w-full sm:w-20" required>
                    <select id="log-unit-select" class="w-full sm:w-auto"></select>
                    <button type="submit" class="btn btn-primary w-full sm:w-auto" data-translate="logButton">Log</button>
                </form>
                <hr class="my-4 border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg" data-translate="todaysLogTitle">Today's Log</h3>
                    <button id="reset-day-btn" class="btn btn-danger text-sm" data-translate="resetButton">Reset</button>
                </div>
                <div id="daily-log-list" class="space-y-3"></div>
            </div>
            <div class="card">
                <div class="flex justify-center items-center gap-4 mb-4">
                    <button id="prev-month-btn" class="text-2xl p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full">‹</button>
                    <h2 class="text-xl" data-translate="monthlyOverviewTitle">Monthly Overview</h2>
                    <button id="next-month-btn" class="text-2xl p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full" disabled>›</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                    <div>
                        <h3 id="monthly-chart-title" class="text-lg mb-3 text-center"></h3>
                        <canvas id="monthly-chart"></canvas>
                        <canvas id="weight-chart" class="mt-6"></canvas>
                    </div>
                    <div><h3 id="heatmap-title" class="text-lg mb-3 text-center"></h3><div id="heatmap" class="heatmap-grid"></div><div id="heatmap-legend" class="heatmap-legend"></div></div>
                </div>
                <div class="text-center mt-4">
                     <button id="log-weight-btn" class="btn btn-secondary text-sm">Log Today's Weight</button>
                 </div>
            </div>
        </div>
        
        <!-- Floating Action Button -->
        <div id="fab" class="fab">+</div>
    </div>
    
    <!-- MODALS & SETTINGS PAGE -->
    <div id="settings-page" class="modal-overlay !items-start !justify-start !bg-opacity-100" style="background-color: var(--background-color);">
        <div class="modal-content !max-w-full !w-full !h-full !rounded-none !shadow-none !p-6 overflow-y-auto">
             <header class="flex justify-between items-center mb-6">
                <h1 class="text-2xl sm:text-3xl font-bold" data-translate="settingsTitle">Settings & Tools</h1>
                <button class="close-btn text-4xl">&times;</button>
            </header>
            <div class="max-w-4xl mx-auto space-y-6">
                 <div class="card">
                    <h2 class="text-xl mb-4" data-translate="achievementsTitle">Achievements</h2>
                    <div id="achievements-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 text-center"></div>
                </div>
                <div class="card">
                    <h2 class="text-xl mb-3" data-translate="goalsTitle">Set Your Daily Goals</h2>
                    <form id="goals-form" class="grid grid-cols-2 gap-3">
                        <div><label for="goal-calories" class="block text-sm font-medium">Calories</label><input type="number" id="goal-calories" min="0" placeholder="2300"></div>
                        <div><label for="goal-protein" class="block text-sm font-medium">Protein (g)</label><input type="number" id="goal-protein" min="0" placeholder="170"></div>
                        <div><label for="goal-carbs" class="block text-sm font-medium">Carbs (g)</label><input type="number" id="goal-carbs" min="0" placeholder="230"></div>
                        <div><label for="goal-fat" class="block text-sm font-medium">Fat (g)</label><input type="number" id="goal-fat" min="0" placeholder="75"></div>
                    </form>
                </div>
                <div class="card">
                    <h3 class="text-lg mb-3" data-translate="savedFoodsTitle">Saved Foods</h3>
                    <div id="food-database-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
                </div>
                <div class="card">
                    <h2 class="text-xl mb-4" data-translate="dataManagementTitle">Data Management</h2>
                     <div class="flex items-center justify-between mb-4">
                        <label for="language-select" class="text-base" data-translate="languageLabel">Language</label>
                        <select id="language-select" class="w-auto">
                            <option value="en">English</option>
                            <option value="hi">हिन्दी</option>
                            <option value="bn">বাংলা</option>
                        </select>
                    </div>
                    <div class="flex items-center justify-between mb-4"><label for="adaptive-theme-toggle" class="text-base" data-translate="adaptiveThemeLabel">Enable Adaptive Theme</label><label class="switch"><input type="checkbox" id="adaptive-theme-toggle"><span class="slider"></span></label></div>
                    <div class="flex flex-col sm:flex-row gap-3"><button id="export-data-btn" class="btn btn-secondary w-full" data-translate="exportButton">Export Data</button><button id="import-data-btn" class="btn btn-secondary w-full" data-translate="importButton">Import Data</button><input type="file" id="import-file-input" class="hidden" accept=".json"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Other Modals -->
    <div id="add-food-choice-modal" class="modal-overlay"><div class="modal-content"><button class="close-btn">&times;</button><h2 class="text-xl mb-4 text-center" data-translate="addFoodChoiceTitle">How would you like to add food?</h2><div class="flex flex-col sm:flex-row gap-4"><button id="open-single-food-modal-btn" class="btn btn-primary w-full" data-translate="addSingleFoodButton">Add Single Food</button><button id="open-bulk-import-modal-btn" class="btn btn-secondary w-full" data-translate="bulkImportButton">Bulk Import</button></div></div></div>
    <div id="add-single-food-modal" class="modal-overlay"><div class="modal-content overflow-y-auto max-h-[90vh]"><button class="close-btn">&times;</button><h2 class="text-xl mb-4" data-translate="addSingleFoodTitle">Add a Food Item</h2><form id="add-food-form" class="space-y-3"><input type="text" id="food-name" required data-translate-placeholder="foodNamePlaceholder"><select id="food-unit" required><option value="g">Grams (g)</option><option value="ml">Milliliters (ml)</option></select><input type="number" id="calories" min="0" required data-translate-placeholder="caloriesPer100"><input type="number" id="protein" min="0" step="0.1" required data-translate-placeholder="proteinPer100"><input type="number" id="carbs" min="0" step="0.1" required data-translate-placeholder="carbsPer100"><input type="number" id="fat" min="0" step="0.1" required data-translate-placeholder="fatPer100"><hr class="my-4"><h3 class="text-lg" data-translate="portionsTitle">Custom Portions (Optional)</h3><p class="text-xs text-gray-500 mb-2">Define custom units for this food, like '1 Katori = 120g'.</p><div id="new-food-portions-container" class="space-y-2"></div><div class="flex gap-2 items-center"><input type="text" id="new-portion-name" placeholder="Portion Name (e.g., Katori)"><input type="number" id="new-portion-value" placeholder="Weight in g/ml"><button type="button" id="add-new-portion-btn" class="btn btn-secondary !px-4">Add</button></div><hr class="my-4"><button type="button" id="toggle-micros-btn" class="btn btn-secondary w-full">Add Micronutrients (Optional)</button><div id="micros-inputs-container" class="hidden grid grid-cols-2 gap-2 mt-4"></div><button type="submit" class="btn btn-primary w-full mt-4" data-translate="saveFoodButton">Save Food</button></form></div></div>
    <div id="bulk-import-modal" class="modal-overlay"><div class="modal-content"><button class="close-btn">&times;</button><h2 class="text-xl mb-4" data-translate="bulkImportTitle">Bulk Data Import</h2><p class="text-sm mb-2" data-translate="bulkImportInstructions">Enter one food per line. Format: <code class="text-xs">Name,Unit,Cals,Prot,Carb,Fat</code></p><textarea id="bulk-import-data" rows="5" data-translate-placeholder="bulkImportPlaceholder"></textarea><button id="bulk-import-btn" class="btn btn-primary w-full mt-3" data-translate="importFoodsButton">Import Foods</button></div></div>
    <div id="alert-modal" class="modal-overlay"><div class="modal-content p-6 rounded-lg w-full max-w-sm text-center"><p id="alert-modal-message" class="mb-5 whitespace-pre-wrap"></p><div id="alert-modal-buttons" class="flex justify-center gap-3"></div></div></div>
    <div id="heatmap-detail-modal" class="modal-overlay"><div class="modal-content !max-w-md text-center"><button class="close-btn">&times;</button><h2 id="heatmap-detail-title" class="text-xl mb-4"></h2><div class="space-y-2"><p><span data-translate="statusLabel">Status</span>: <span id="heatmap-detail-status" class="font-semibold"></span></p><p><span data-translate="intakeLabel">Intake</span>: <span id="heatmap-detail-intake" class="font-semibold"></span></p><p><span data-translate="targetLabel">Target</span>: <span id="heatmap-detail-target" class="font-semibold"></span></p><p><span data-translate="varianceLabel">Variance</span>: <span id="heatmap-detail-variance" class="font-semibold"></span></p><p id="heatmap-detail-weight-container" class="hidden">Weight: <span id="heatmap-detail-weight" class="font-semibold"></span></p></div></div></div>
    <div id="micros-modal" class="modal-overlay"><div class="modal-content !max-w-lg"><button class="close-btn">&times;</button><h2 class="text-xl mb-4" data-translate="microsTitle">Monthly Micronutrient Details</h2><div id="micros-modal-content" class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4 max-h-[60vh] overflow-y-auto pr-2"></div></div></div>
    <div id="log-weight-modal" class="modal-overlay"><div class="modal-content"><button class="close-btn">&times;</button><h2 class="text-xl mb-4">Log Your Weight</h2><form id="log-weight-form"><input type="number" id="weight-input" step="0.1" required placeholder="Enter weight in kg"><button type="submit" class="btn btn-primary w-full mt-4">Save Weight</button></form></div></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const el = (id) => document.getElementById(id);
            const root = document.documentElement;
            let audioCtx;

            // --- DOM ELEMENTS ---
            const greetingEl = el('greeting');
            const insightMessageEl = el('insight-message');
            const circularTotalsDisplay = el('circular-totals-display');
            const fab = el('fab');
            const settingsPage = el('settings-page');
            const openSettingsPageBtn = el('open-settings-page-btn');
            const achievementsGrid = el('achievements-grid');
            const adaptiveThemeToggle = el('adaptive-theme-toggle');
            const languageSelect = el('language-select');
            const foodDatabaseList = el('food-database-list');
            const foodSelect = el('food-select');
            const logFoodForm = el('log-food-form');
            const dailyLogList = el('daily-log-list');
            const resetDayBtn = el('reset-day-btn');
            const monthlyChartEl = el('monthly-chart');
            const weightChartEl = el('weight-chart');
            const heatmapEl = el('heatmap');
            const heatmapLegendEl = el('heatmap-legend');
            const monthlyChartTitle = el('monthly-chart-title');
            const heatmapTitle = el('heatmap-title');
            const goalsForm = el('goals-form');
            const waterTracker = el('water-tracker');
            const logWeightBtn = el('log-weight-btn');
            const prevMonthBtn = el('prev-month-btn');
            const nextMonthBtn = el('next-month-btn');

            const modals = {
                choice: el('add-food-choice-modal'), single: el('add-single-food-modal'),
                bulk: el('bulk-import-modal'), settings: settingsPage,
                alert: el('alert-modal'), heatmapDetail: el('heatmap-detail-modal'),
                micros: el('micros-modal'), weight: el('log-weight-modal'),
            };

            // --- STATE ---
            let foodDatabase = [], dailyLog = [], monthlyChart, weightChart;
            let dailyGoals = { calories: 2300, protein: 170, carbs: 230, fat: 75 };
            let unlockedAchievements = [];
            let adaptiveThemeEnabled = true;
            let currentLang = 'en';
            let currentFoodPortions = {};
            let waterIntake = 0;
            let weightLog = {};
            let currentlyViewedDate = new Date();

            // --- CONSTANTS ---
            const ACHIEVEMENTS = {
                'firstWeek': { name: 'First Week Logged', desc: 'Log your meals for 7 consecutive days.', icon: '🗓️' },
                'perfectDay': { name: 'Perfect Macro Day', desc: 'Hit all 4 macro goals in a single day.', icon: '🎯' },
                'explorer': { name: 'Explorer', desc: 'Log 50 different types of food.', icon: '🧭' },
                'dbBuilder': { name: 'Database Builder', desc: 'Save 25 foods to your database.', icon: '📚'}
            };
             const RDAs = {
                vitaminA: 900, vitaminC: 90, vitaminD: 20, vitaminE: 15, vitaminK: 120,
                vitaminB1: 1.2, vitaminB2: 1.3, vitaminB3: 16, vitaminB6: 1.7, vitaminB12: 2.4,
                iron: 18, calcium: 1300, zinc: 11, magnesium: 420, potassium: 3400, sodium: 2300,
                omega3: 1.6, 
            };
            const MICRONUTRIENTS = {
                vitaminA: 'mcg', vitaminC: 'mg', vitaminD: 'mcg', vitaminE: 'mg', vitaminK: 'mcg',
                vitaminB1: 'mg', vitaminB2: 'mg', vitaminB3: 'mg', vitaminB6: 'mg', vitaminB12: 'mcg',
                iron: 'mg', calcium: 'mg', zinc: 'mg', magnesium: 'mg', potassium: 'mg', sodium: 'mg',
                omega3: 'g'
            };


            // --- TRANSLATIONS ---
            const translations = {
                greetingGoodMorning: { en: 'Good morning!', hi: 'शुभ प्रभात!', bn: 'শুভ সকাল!' },
                greetingGoodAfternoon: { en: 'Good afternoon!', hi: 'नमस्कार!', bn: 'শুভ অপরাহ্ন!' },
                greetingGoodEvening: { en: 'Good evening!', hi: 'शुभ संध्या!', bn: 'শুভ সন্ধ্যা!' },
                insightConsecutive: (days) => ({ en: `You've logged ${days} days in a row. Keep it up!`, hi: `आपने लगातार ${days} दिनों तक लॉग इन किया है। लगे रहो!`, bn: `আপনি টানা ${days} দিন লগ করেছেন। চালিয়ে যান!` }),
                insightDefault: { en: "Let's get those calories logged for today!", hi: 'आइए आज के लिए उन calories को लॉग करें!', bn: 'চলুন আজকের calories লগ করা যাক!' },
                summaryTitle: { en: "Today's Nutrition Summary", hi: "आज का Nutrition Summary", bn: "আজকের Nutrition Summary" },
                monthlyOverviewTitle: { en: 'Monthly Overview', hi: 'Monthly Overview', bn: 'Monthly Overview' },
                logFoodTitle: { en: 'Log Food for Today', hi: 'आज के लिए खाना लॉग करें', bn: 'আজকের জন্য খাবার লগ করুন' },
                selectFoodOption: { en: '-- Select a food --', hi: '-- एक भोजन चुनें --', bn: '-- একটি খাবার নির্বাচন করুন --' },
                amountPlaceholder: { en: 'Amount', hi: 'मात्रा', bn: 'পরিমাণ' },
                logButton: { en: 'Log', hi: 'लॉग', bn: 'লগ' },
                todaysLogTitle: { en: "Today's Log", hi: "आज का Log", bn: "আজকের Log" },
                resetButton: { en: 'Reset', hi: 'रीसेट', bn: 'রিসেট' },
                settingsTitle: { en: 'Settings & Tools', hi: 'सेटिंग्स और उपकरण', bn: 'সেটিংস এবং টুলস' },
                achievementsTitle: { en: 'Achievements', hi: 'उपलब्धियां', bn: 'কৃতিত্ব' },
                goalsTitle: { en: 'Set Your Daily Goals', hi: 'अपने दैनिक लक्ष्य निर्धारित करें', bn: 'আপনার দৈনিক লক্ষ্য সেট করুন' },
                savedFoodsTitle: { en: 'Saved Foods', hi: 'सहेजे गए खाद्य पदार्थ', bn: 'সংরক্ষিত খাবার' },
                dataManagementTitle: { en: 'Data Management', hi: 'डेटा प्रबंधन', bn: 'ডেটা ম্যানেজমেন্ট' },
                languageLabel: { en: 'Language', hi: 'भाषा', bn: 'ভাষা' },
                adaptiveThemeLabel: { en: 'Enable Adaptive Theme', hi: 'अनुकूली थीम सक्षम करें', bn: 'অ্যাডাপটিভ থিম সক্রিয় করুন' },
                exportButton: { en: 'Export Data', hi: 'डेटा निर्यात करें', bn: 'ডেটা এক্সপোর্ট করুন' },
                importButton: { en: 'Import Data', hi: 'डेटा आयात करें', bn: 'ডেটা ইম্পোর্ট করুন' },
                addFoodChoiceTitle: { en: 'How would you like to add food?', hi: 'आप खाना कैसे जोड़ना चाहेंगे?', bn: 'আপনি কিভাবে খাবার যোগ করতে চান?' },
                addSingleFoodButton: { en: 'Add Single Food', hi: 'एकल भोजन जोड़ें', bn: 'একটি খাবার যোগ করুন' },
                bulkImportButton: { en: 'Bulk Import', hi: 'थोक आयात', bn: 'বাল্ক ইম্পোর্ট' },
                addSingleFoodTitle: { en: 'Add a Food Item', hi: 'एक खाद्य आइटम जोड़ें', bn: 'একটি খাদ্য আইটেম যোগ করুন' },
                foodNamePlaceholder: { en: 'Food Name', hi: 'भोजन का नाम', bn: 'খাবারের নাম' },
                caloriesPer100: { en: 'Calories per 100 units', hi: 'प्रति 100 units कैलोरी', bn: 'প্রতি 100 ইউনিটে ক্যালোরি' },
                proteinPer100: { en: 'Protein (g) per 100 units', hi: 'प्रति 100 units प्रोटीन (g)', bn: 'প্রতি 100 ইউনিটে প্রোটিন (g)' },
                carbsPer100: { en: 'Carbs (g) per 100 units', hi: 'प्रति 100 units कार्ब्स (g)', bn: 'प्रति 100 ইউনিটে কার্বোহাইড্রেট (g)' },
                fatPer100: { en: 'Fat (g) per 100 units', hi: 'प्रति 100 units वसा (g)', bn: 'প্রতি 100 ইউনিটে ফ্যাট (g)' },
                saveFoodButton: { en: 'Save Food', hi: 'खाना सहेजें', bn: 'খাবার সংরক্ষণ করুন' },
                bulkImportTitle: { en: 'Bulk Data Import', hi: 'थोक डेटा आयात', bn: 'বাল্ক ডেটা ইম্পোর্ট' },
                bulkImportInstructions: { en: 'Enter one food per line. Format: Name,Unit,Cals,Prot,Carb,Fat', hi: 'प्रति पंक्ति एक भोजन दर्ज करें। प्रारूप: নাম,इकाई,कैलोरी,प्रोटीन,कार्ब,वसा', bn: 'প্রতি লাইনে একটি করে খাবার লিখুন। ফরম্যাট: নাম, ইউনিট, ক্যালোরি, প্রোটিন, কার্ব, ফ্যাট' },
                bulkImportPlaceholder: { en: 'Cooked Rice,g,130,2.7,28,0.3\nMilk,ml,42,3.4,5,1', hi: 'पका हुआ चावल,g,130,2.7,28,0.3\nदूध,ml,42,3.4,5,1', bn: 'রান্না করা ভাত,g,130,2.7,28,0.3\nদুধ,ml,42,3.4,5,1' },
                importFoodsButton: { en: 'Import Foods', hi: 'खाद्य पदार्थ आयात करें', bn: 'খাবার ইম্পোর্ট করুন' },
                statusLabel: { en: 'Status', hi: 'स्थिति', bn: 'স্ট্যাটাস' },
                intakeLabel: { en: 'Intake', hi: 'सेवन', bn: 'গ্রহণ' },
                targetLabel: { en: 'Target', hi: 'लक्ष्य', bn: 'লক্ষ্য' },
                varianceLabel: { en: 'Variance', hi: 'अंतर', bn: 'ব্যবধান' },
                foodAddedAlert: { en: 'Food added!', hi: 'भोजन जोड़ा गया!', bn: 'খাবার যোগ করা হয়েছে!' },
                importSuccessAlert: { en: 'Data imported!', hi: 'डेटा आयात किया गया!', bn: 'ডেটা ইম্পোর্ট করা হয়েছে!' },
                exportSuccessAlert: { en: 'Data exported!', hi: 'डेटा निर्यात किया गया!', bn: 'ডেটা এক্সপোর্ট করা হয়েছে!' },
                resetConfirm: { en: "Clear today's log?", hi: 'आज का लॉग साफ़ करें?', bn: 'আজকের লগ সাফ করবেন?' },
                importConfirm: { en: 'This will overwrite all current data?', hi: 'यह सभी मौजूदा डेटा को अधिलेखित कर देगा?', bn: 'এটি সমস্ত বর্তমান ডেটা ওভাররাইট করবে?' },
                viewMicrosButton: { en: 'Micronutrients', hi: 'Micronutrients', bn: 'Micronutrients' },
                portionsTitle: { en: 'My Portions', hi: 'मेरे हिस्से', bn: 'আমার অংশ' },
                microsTitle: { en: 'Micronutrient Details', hi: 'Micronutrient विवरण', bn: 'Micronutrient বিবরণ' },
                hydrationTitle: { en: "Today's Hydration", hi: 'आज का हाइड्रेशन', bn: 'আজকের হাইড্রেশন' },
            };

            const setLanguage = (lang) => {
                currentLang = lang;
                document.querySelectorAll('[data-translate]').forEach(el => {
                    const key = el.dataset.translate;
                    if (translations[key]) {
                        el.textContent = translations[key][lang];
                    }
                });
                document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
                    const key = el.dataset.translatePlaceholder;
                    if (translations[key]) {
                        el.placeholder = translations[key][lang];
                    }
                });
            };


            const getTodayKey = () => `dailyLog_${new Date().toISOString().split('T')[0]}`;
            const openModal = (modal) => modal.classList.add('visible');
            const closeModal = (modal) => modal.classList.remove('visible');
            const showAlert = (message, buttons = [{ text: 'OK', class: 'btn-primary' }]) => {
                return new Promise(resolve => {
                    el('alert-modal-message').textContent = message;
                    const btnContainer = el('alert-modal-buttons');
                    btnContainer.innerHTML = '';
                    buttons.forEach(btnInfo => {
                        const button = document.createElement('button');
                        button.textContent = btnInfo.text;
                        button.className = `btn ${btnInfo.class}`;
                        button.onclick = () => { closeModal(modals.alert); resolve(btnInfo.resolvesTo); };
                        btnContainer.appendChild(button);
                    });
                    openModal(modals.alert);
                });
            };

            const saveData = () => {
                localStorage.setItem('foodDatabase', JSON.stringify(foodDatabase));
                localStorage.setItem(getTodayKey(), JSON.stringify(dailyLog));
                localStorage.setItem('dailyGoals', JSON.stringify(dailyGoals));
                localStorage.setItem('adaptiveThemeEnabled', JSON.stringify(adaptiveThemeEnabled));
                localStorage.setItem('unlockedAchievements', JSON.stringify(unlockedAchievements));
                localStorage.setItem('language', currentLang);
                localStorage.setItem('customPortions', JSON.stringify(customPortions));
                localStorage.setItem(`waterIntake_${getTodayKey()}`, waterIntake);
                localStorage.setItem('weightLog', JSON.stringify(weightLog));
            };
            const loadData = () => {
                foodDatabase = JSON.parse(localStorage.getItem('foodDatabase') || '[]');
                dailyLog = JSON.parse(localStorage.getItem(getTodayKey()) || '[]');
                dailyGoals = JSON.parse(localStorage.getItem('dailyGoals')) || { calories: 2300, protein: 170, carbs: 230, fat: 75 };
                adaptiveThemeEnabled = JSON.parse(localStorage.getItem('adaptiveThemeEnabled') ?? 'true');
                unlockedAchievements = JSON.parse(localStorage.getItem('unlockedAchievements') || '[]');
                currentLang = localStorage.getItem('language') || 'en';
                customPortions = JSON.parse(localStorage.getItem('customPortions') || '{}');
                waterIntake = parseInt(localStorage.getItem(`waterIntake_${getTodayKey()}`) || '0');
                weightLog = JSON.parse(localStorage.getItem('weightLog') || '{}');
                adaptiveThemeToggle.checked = adaptiveThemeEnabled;
                languageSelect.value = currentLang;
            };

            const getDailyPerformanceScore = (calories, goal) => {
                if (!calories || goal <= 0) return 0;
                const ratio = calories / goal;
                if (ratio >= 0.9 && ratio <= 1.1) return 2;
                if ((ratio >= 0.8 && ratio < 0.9) || (ratio > 1.1 && ratio <= 1.2)) return 1;
                if (ratio < 0.8) return -1;
                if (ratio > 1.2) return -2;
                return 0;
            };

            const calculateHealthScore = () => {
                let totalScore = 0;
                const today = new Date();
                for (let i = 0; i < 45; i++) {
                    const date = new Date();
                    date.setDate(today.getDate() - i);
                    const key = `dailyLog_${date.toISOString().split('T')[0]}`;
                    const dayLog = JSON.parse(localStorage.getItem(key) || '[]');
                    const totalCalories = dayLog.reduce((sum, item) => {
                        const food = foodDatabase[item.foodIndex];
                        return sum + (food ? food.calories * (item.amount / 100) : 0);
                    }, 0);
                    totalScore += getDailyPerformanceScore(totalCalories, dailyGoals.calories);
                }
                return totalScore / 45;
            };

            const applyTheme = () => {
                let theme;
                if (!adaptiveThemeEnabled) {
                    theme = { primary: '#2196F3', background: '#FFFFFF', gradient: 'linear-gradient(45deg, #2196F3, #64B5F6)' };
                } else {
                    const score = calculateHealthScore();
                    if (score >= 1.5) theme = { primary: '#2E7D32', background: '#E8F5E9', gradient: 'linear-gradient(45deg, #2E7D32, #4CAF50)' }; 
                    else if (score >= 0.5) theme = { primary: '#4CAF50', background: '#F1F8E9', gradient: 'linear-gradient(45deg, #4CAF50, #81C784)' };
                    else if (score > -0.5) theme = { primary: '#2196F3', background: '#FFFFFF', gradient: 'linear-gradient(45deg, #2196F3, #64B5F6)' };
                    else if (score > -1.5) theme = { primary: '#FF9800', background: '#FFF3E0', gradient: 'linear-gradient(45deg, #FF9800, #FFB74D)' };
                    else theme = { primary: '#D32F2F', background: '#FFEBEE', gradient: 'linear-gradient(45deg, #D32F2F, #E57373)' };
                }
                root.style.setProperty('--primary-color', theme.primary);
                root.style.setProperty('--background-color', theme.background);
                root.style.setProperty('--primary-gradient', theme.gradient);
            };
            
            const calculateDailyTotals = () => {
                let totals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
                Object.keys(MICRONUTRIENTS).forEach(m => totals[m] = 0);

                // Add from food log
                dailyLog.forEach(item => {
                    const food = foodDatabase[item.foodIndex];
                    if (food) {
                        const mult = item.amount / 100;
                        Object.keys(totals).forEach(k => {
                            if (food[k] !== undefined) totals[k] += food[k] * mult;
                            if (food.micros && food.micros[k] !== undefined) totals[k] += food.micros[k] * mult;
                        });
                    }
                });
                return totals;
            };
            
            const renderGreetingAndInsight = () => {
                const hours = new Date().getHours();
                if (hours < 12) greetingEl.textContent = translations.greetingGoodMorning[currentLang];
                else if (hours < 18) greetingEl.textContent = translations.greetingGoodAfternoon[currentLang];
                else greetingEl.textContent = translations.greetingGoodEvening[currentLang];

                const consecutiveDays = countConsecutiveLogDays();
                if(consecutiveDays > 1) {
                    insightMessageEl.textContent = translations.insightConsecutive(consecutiveDays)[currentLang];
                } else {
                    insightMessageEl.textContent = translations.insightDefault[currentLang];
                }
            };
            
            const renderCircularTotals = () => {
                circularTotalsDisplay.innerHTML = '';
                const totals = calculateDailyTotals();
                const macroInfo = {
                    calories: { color: '#f97316', light: '#ffedd5', darkText: '#c2410c', name: 'Calories' },
                    protein:  { color: '#ef4444', light: '#fee2e2', darkText: '#b91c1c', name: 'Protein' },
                    carbs:    { color: '#0ea5e9', light: '#e0f2fe', darkText: '#0369a1', name: 'Carbs' },
                    fat:      { color: '#facc15', light: '#fef9c3', darkText: '#a16207', name: 'Fat' }
                };

                Object.keys(macroInfo).forEach(macro => {
                    const config = macroInfo[macro];
                    const value = totals[macro];
                    const goal = dailyGoals[macro] || 1;
                    const percent = Math.min(100, (value / goal) * 100);
                    const unit = macro === 'calories' ? '' : 'g';
                    
                    const radius = 45;
                    const strokeWidth = 10;
                    const innerRadius = radius - strokeWidth / 2;
                    const circumference = 2 * Math.PI * innerRadius;
                    const offset = circumference - (percent / 100) * circumference;

                    const circularBarHTML = `
                        <div class="flex flex-col items-center progress-circle-container">
                            <svg class="progress-circle" width="120" height="120" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="${innerRadius}" stroke="${config.light}" stroke-width="${strokeWidth}" fill="transparent"></circle>
                                <circle class="progress-circle-bar" cx="50" cy="50" r="${innerRadius}" stroke="${config.color}" stroke-width="${strokeWidth}" fill="transparent" stroke-linecap="round"
                                    stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"></circle>
                                <text x="50%" y="50%" text-anchor="middle" dy=".3em" font-size="16" fill="${config.darkText}" font-weight="600">${value.toFixed(0)}${unit}</text>
                            </svg>
                            <p class="text-sm font-semibold capitalize mt-2" style="color: ${config.darkText};">${config.name}</p>
                        </div>
                    `;
                    circularTotalsDisplay.innerHTML += circularBarHTML;
                });
            };

            const checkAchievements = () => {
                const newlyUnlocked = [];
                if (!unlockedAchievements.includes('firstWeek') && countConsecutiveLogDays() >= 7) {
                    newlyUnlocked.push('firstWeek');
                }
                if (!unlockedAchievements.includes('perfectDay')) {
                    const totals = calculateDailyTotals();
                    const perfect = ['calories', 'protein', 'carbs', 'fat'].every(m => {
                        const goal = dailyGoals[m];
                        return goal > 0 && totals[m] >= goal;
                    });
                    if(perfect) newlyUnlocked.push('perfectDay');
                }
                if(!unlockedAchievements.includes('explorer')) {
                    const loggedFoodIndices = new Set();
                    for(let i=0; i<localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if(key.startsWith('dailyLog_')) {
                            const log = JSON.parse(localStorage.getItem(key));
                            log.forEach(item => loggedFoodIndices.add(item.foodIndex));
                        }
                    }
                    if(loggedFoodIndices.size >= 50) newlyUnlocked.push('explorer');
                }
                if(!unlockedAchievements.includes('dbBuilder') && foodDatabase.length >= 25) {
                    newlyUnlocked.push('dbBuilder');
                }
                
                if (newlyUnlocked.length > 0) {
                    unlockedAchievements.push(...newlyUnlocked);
                    const achievement = ACHIEVEMENTS[newlyUnlocked[0]];
                    showAlert(`Achievement Unlocked!\n${achievement.icon} ${achievement.name}\n${achievement.desc}`);
                    saveData();
                    renderAchievements();
                }
            };
            
            const renderAchievements = () => {
                achievementsGrid.innerHTML = '';
                Object.keys(ACHIEVEMENTS).forEach(key => {
                    const achievement = ACHIEVEMENTS[key];
                    const isUnlocked = unlockedAchievements.includes(key);
                    const badgeEl = document.createElement('div');
                    badgeEl.className = `badge p-2 flex flex-col items-center justify-center ${isUnlocked ? 'unlocked' : ''}`;
                    badgeEl.innerHTML = `
                        <div class="badge-icon">${achievement.icon}</div>
                        <p class="font-semibold text-sm mt-2">${achievement.name}</p>
                        <p class="text-xs text-center" style="color: var(--text-color-secondary);">${achievement.desc}</p>
                    `;
                    achievementsGrid.appendChild(badgeEl);
                });
            };
            
            const countConsecutiveLogDays = () => {
                let count = 0;
                const today = new Date();
                for (let i = 0; i < 365; i++) {
                    const date = new Date();
                    date.setDate(today.getDate() - i);
                    const key = `dailyLog_${date.toISOString().split('T')[0]}`;
                    if (localStorage.getItem(key) && JSON.parse(localStorage.getItem(key)).length > 0) {
                        count++;
                    } else {
                        break;
                    }
                }
                return count;
            };

            const renderFoodDatabase = () => {
                foodDatabaseList.innerHTML = ''; foodSelect.innerHTML = `<option value="">${translations.selectFoodOption[currentLang]}</option>`;
                if (foodDatabase.length === 0) { foodDatabaseList.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400">No foods saved yet.</p>`; return; }
                foodDatabase.forEach((food, index) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex justify-between items-center p-2 bg-gray-100 dark:bg-slate-700/50 rounded-md text-sm';
                    itemEl.innerHTML = `<div><p class="font-semibold">${food.name}</p><p class="text-xs">${food.calories} kcal / 100${food.unit}</p></div><button data-index="${index}" class="btn btn-danger delete-food-btn">X</button>`;
                    foodDatabaseList.appendChild(itemEl);
                    const optionEl = document.createElement('option');
                    optionEl.value = index; optionEl.textContent = `${food.name} (per 100${food.unit})`;
                    foodSelect.appendChild(optionEl);
                });
            };

            const renderDailyLog = () => {
                dailyLogList.innerHTML = '';
                if (dailyLog.length === 0) { dailyLogList.innerHTML = `<p class="text-center mt-4 text-sm text-gray-500 dark:text-gray-400">No food logged for today.</p>`; return; }
                dailyLog.forEach((logItem, index) => {
                    const food = foodDatabase[logItem.foodIndex]; if (!food) return;
                    const mult = logItem.amount / 100;
                    const logEl = document.createElement('div');
                    logEl.className = 'grid grid-cols-8 gap-2 items-center text-sm p-2 rounded-md hover:bg-gray-100 dark:hover:bg-slate-700/50';
                    logEl.innerHTML = `<div class="col-span-2 font-semibold">${food.name}</div><div class="text-gray-600 dark:text-gray-400">${logItem.amount.toFixed(0)}${food.unit}</div><div class="font-medium">${(food.calories * mult).toFixed(0)} kcal</div><div class="text-blue-600 dark:text-blue-400">${(food.protein * mult).toFixed(1)}g P</div><div class="text-emerald-600 dark:text-emerald-400">${(food.carbs * mult).toFixed(1)}g C</div><div class="text-amber-600 dark:text-amber-400">${(food.fat * mult).toFixed(1)}g F</div><div class="text-right"><button data-index="${index}" class="btn btn-danger delete-log-btn text-xs">Del</button></div>`;
                    dailyLogList.appendChild(logEl);
                });
            };
            const renderGoals = () => Object.keys(dailyGoals).forEach(g => el(`goal-${g}`).value = dailyGoals[g] || '');
            const getMonthlyData = (date) => {
                const prefix = `dailyLog_${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-`;
                let data = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith(prefix)) {
                        const day = parseInt(key.split('-')[2]);
                        const dayLog = JSON.parse(localStorage.getItem(key));
                        data[day] = dayLog.reduce((acc, item) => {
                           const food = foodDatabase[item.foodIndex];
                            if (food) {
                                const mult = item.amount / 100;
                                ['calories', 'protein', 'carbs', 'fat'].forEach(k => { if(food[k] !== undefined) acc[k] += food[k] * mult });
                                if (food.micros) {
                                    Object.keys(food.micros).forEach(m => {
                                        if (acc[m] === undefined) acc[m] = 0;
                                        acc[m] += food.micros[m] * mult;
                                    });
                                }
                            }
                            return acc;
                        }, { calories: 0, protein: 0, carbs: 0, fat: 0 });
                    }
                }
                return data;
            };
            const renderMonthlyOverview = (date) => {
                const monthlyData = getMonthlyData(date);
                const monthName = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                monthlyChartTitle.textContent = `${monthName} Totals`; 
                heatmapTitle.textContent = `${monthName} Calorie Map`;
                
                const monthlyTotals = Object.values(monthlyData).reduce((acc, day) => { Object.keys(acc).forEach(k => { if(acc[k] !== undefined) acc[k] += day[k]}); return acc; }, { protein: 0, carbs: 0, fat: 0 });
                if (monthlyChart) monthlyChart.destroy();
                monthlyChart = new Chart(monthlyChartEl, { type: 'bar', data: { labels: ['Protein (g)', 'Carbs (g)', 'Fat (g)'], datasets: [{ label: 'Total Intake', data: [monthlyTotals.protein, monthlyTotals.carbs, monthlyTotals.fat], backgroundColor: ['#ef4444', '#0ea5e9', '#facc15'] }] }, options: { scales: { y: { beginAtZero: true } } } });
                
                heatmapEl.innerHTML = '';
                const year = date.getFullYear(), month = date.getMonth();
                const today = new Date();
                const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
                const daysInMonth = new Date(year, month + 1, 0).getDate(), firstDay = new Date(year, month, 1).getDay();
                const colors = { on: '#4CAF50', over: '#FF9800', under: '#2196F3', none: '#E0E0E0' };
                for(let i = 0; i < firstDay; i++) heatmapEl.innerHTML += `<div></div>`;
                for(let day = 1; day <= daysInMonth; day++) {
                    const cell = document.createElement('div');
                    cell.classList.add('heatmap-cell');
                    if (isCurrentMonth && day === today.getDate()) cell.classList.add('current-day');
                    const dayData = monthlyData[day];
                    let status = 'No Data', color = colors.none, intake = 0;
                    if (dayData) {
                        intake = dayData.calories;
                        const score = getDailyPerformanceScore(intake, dailyGoals.calories);
                        if(score === 2 || score === 1) { status = 'On Target'; color = colors.on; }
                        else if (score === -1) { status = 'Under Target'; color = colors.under; }
                        else if (score === -2) { status = 'Over Target'; color = colors.over; }
                    }
                    cell.style.backgroundColor = color;
                    cell.innerHTML = `<span class="heatmap-day-number">${day}</span>`;
                    cell.addEventListener('click', () => {
                        const clickedDate = new Date(year, month, day);
                        el('heatmap-detail-title').textContent = clickedDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                        el('heatmap-detail-status').textContent = status;
                        el('heatmap-detail-intake').textContent = `${intake.toFixed(0)} kcal`;
                        el('heatmap-detail-target').textContent = `${dailyGoals.calories} kcal`;
                        const variance = intake - dailyGoals.calories;
                        el('heatmap-detail-variance').textContent = `${variance >= 0 ? '+' : ''}${variance.toFixed(0)} kcal`;

                        const weight = getMostRecentWeight(clickedDate);
                        const weightContainer = el('heatmap-detail-weight-container');
                        if(weight) {
                            el('heatmap-detail-weight').textContent = `${weight} kg`;
                            weightContainer.classList.remove('hidden');
                        } else {
                            weightContainer.classList.add('hidden');
                        }
                        openModal(modals.heatmapDetail);
                    });
                    heatmapEl.appendChild(cell);
                }
                heatmapLegendEl.innerHTML = `<div class="legend-item"><div class="legend-color-box" style="background-color: ${colors.on};"></div> On Target</div><div class="legend-item"><div class="legend-color-box" style="background-color: ${colors.over};"></div> Over Target</div><div class="legend-item"><div class="legend-color-box" style="background-color: ${colors.under};"></div> Under Target</div><div class="legend-item"><div class="legend-color-box" style="background-color: ${colors.none};"></div> No Data</div>`;

                nextMonthBtn.disabled = isCurrentMonth;
                renderWeightChart();
            };

            const renderMicrosModal = () => {
                const monthlyData = getMonthlyData(currentlyViewedDate);
                const daysInMonth = new Date(currentlyViewedDate.getFullYear(), currentlyViewedDate.getMonth() + 1, 0).getDate();

                const monthlyTotals = {};
                Object.keys(MICRONUTRIENTS).forEach(m => monthlyTotals[m] = 0);
                
                Object.values(monthlyData).forEach(dayData => {
                    Object.keys(MICRONUTRIENTS).forEach(m => {
                        if (dayData[m]) monthlyTotals[m] += dayData[m];
                    });
                });

                const container = el('micros-modal-content');
                container.innerHTML = '';
                
                const createSection = (title, keys) => {
                    container.innerHTML += `<h3 class="text-lg font-semibold col-span-1 sm:col-span-2">${title}</h3>`;
                    keys.forEach(micro => {
                        const value = monthlyTotals[micro] || 0;
                        const rda = (RDAs[micro] || 1) * daysInMonth;
                        const percent = Math.min(100, (value / rda) * 100);
                        const unit = MICRONUTRIENTS[micro];
                        
                        const microEl = document.createElement('div');
                        microEl.innerHTML = `
                            <div class="flex justify-between items-baseline mb-1">
                                <span class="font-semibold capitalize">${micro.replace('vitamin', 'Vit ')}</span>
                                <span class="text-sm" style="color:var(--text-color-secondary)">${value.toFixed(1)}${unit} / ${rda.toFixed(0)}${unit}</span>
                            </div>
                            <div class="progress-container"><div class="progress-bar" style="width: ${percent}%; background-color: var(--primary-color);"></div></div>
                        `;
                        container.appendChild(microEl);
                    });
                };

                createSection('Vitamins', Object.keys(MICRONUTRIENTS).filter(k => k.startsWith('vitamin')));
                createSection('Minerals', Object.keys(MICRONUTRIENTS).filter(k => !k.startsWith('vitamin') && k !== 'omega3'));
                createSection('Fats', ['omega3']);
            };
            
            const playPlopSound = () => {
                if (!audioCtx) {
                    try {
                        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    } catch(e) {
                        console.error("Web Audio API is not supported in this browser");
                        return;
                    }
                }
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + 0.2);
            };

            const renderWaterTracker = () => {
                waterTracker.innerHTML = '';
                for(let i=1; i<=10; i++) {
                    const glass = document.createElement('div');
                    glass.dataset.index = i;
                    glass.className = 'glass';
                    if (i <= waterIntake) glass.classList.add('filled');
                    glass.innerHTML = `<svg viewBox="0 0 16 16" class="w-8 h-8"><path class="glass-outline" d="M1.323 2.158a1 1 0 0 1 .947-.658h11.46a1 1 0 0 1 .946.658L16 5.5v9a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 14.5v-9l1.323-3.342Z"/><path class="water-fill" d="M1.323 2.158a1 1 0 0 1 .947-.658h11.46a1 1 0 0 1 .946.658L16 5.5v9a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 14.5v-9l1.323-3.342Z"/></svg>`;
                    waterTracker.appendChild(glass);
                }
                el('water-counter').textContent = `You've had ${waterIntake} / 10 glasses today.`;
            };
            
            const renderWeightChart = () => {
                const labels = [];
                const data = [];
                const ninetyDaysAgo = new Date();
                ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);

                Object.keys(weightLog).sort().forEach(dateKey => {
                    const entryDate = new Date(dateKey + 'T00:00:00');
                    if (entryDate >= ninetyDaysAgo) {
                         labels.push(dateKey);
                         data.push(weightLog[dateKey]);
                    }
                });

                if(weightChart) weightChart.destroy();
                weightChart = new Chart(weightChartEl, {
                    type: 'line',
                    data: { labels, datasets: [{ label: 'Weight (kg) - Last 90 Days', data, borderColor: 'var(--primary-color)', tension: 0.1 }] },
                    options: { scales: { y: { beginAtZero: false } } }
                });
            };

            const getMostRecentWeight = (targetDate) => {
                const sortedKeys = Object.keys(weightLog).sort().reverse();
                const targetKey = targetDate.toISOString().split('T')[0];
                for (const key of sortedKeys) {
                    if (key <= targetKey) {
                        return weightLog[key];
                    }
                }
                return null;
            };

            const updateUI = () => {
                setLanguage(currentLang);
                applyTheme();
                renderGreetingAndInsight();
                renderCircularTotals();
                renderFoodDatabase();
                renderDailyLog();
                renderGoals();
                renderMonthlyOverview(currentlyViewedDate);
                renderAchievements();
                renderWaterTracker();
            };

            // --- EVENT LISTENERS ---
            fab.addEventListener('click', () => {
                el('add-food-form').reset();
                el('micros-inputs-container').innerHTML = '';
                el('micros-inputs-container').classList.add('hidden');
                el('new-food-portions-container').innerHTML = '';
                currentFoodPortions = {};
                openModal(modals.choice)
            });
            openSettingsPageBtn.addEventListener('click', () => openModal(settingsPage));
            Object.values(modals).forEach(m => {
                m.addEventListener('click', (e) => { if (e.target === m) closeModal(m); });
                m.querySelector('.close-btn')?.addEventListener('click', () => closeModal(m));
            });
            el('open-single-food-modal-btn').addEventListener('click', () => { closeModal(modals.choice); openModal(modals.single); });
            el('open-bulk-import-modal-btn').addEventListener('click', () => { closeModal(modals.choice); openModal(modals.bulk); });
            
            languageSelect.addEventListener('change', (e) => { setLanguage(e.target.value); saveData(); updateUI(); });

            el('add-food-form').addEventListener('submit', (e) => { 
                e.preventDefault(); 
                const newFood = { 
                    name: el('food-name').value, unit: el('food-unit').value, 
                    calories: parseFloat(el('calories').value) || 0, protein: parseFloat(el('protein').value) || 0, 
                    carbs: parseFloat(el('carbs').value) || 0, fat: parseFloat(el('fat').value) || 0,
                    portions: currentFoodPortions,
                    micros: {}
                };

                document.querySelectorAll('#micros-inputs-container input').forEach(input => {
                    const value = parseFloat(input.value);
                    if(value > 0) newFood.micros[input.dataset.micro] = value;
                });
                
                foodDatabase.push(newFood);
                e.target.reset(); 
                saveData(); 
                updateUI(); 
                closeModal(modals.single); 
                showAlert(translations.foodAddedAlert[currentLang]); 
            });
            el('bulk-import-btn').addEventListener('click', () => { const lines = el('bulk-import-data').value.trim().split('\n'); let added = 0, invalid = []; lines.forEach((line, i) => { if (!line.trim()) return; const parts = line.split(','); if (parts.length === 6) { const [name, unit, cal, prot, carb, fat] = parts.map(p => p.trim()); if (name && ['g', 'ml'].includes(unit.toLowerCase()) && !isNaN(parseFloat(cal)) && !isNaN(parseFloat(prot)) && !isNaN(parseFloat(carb)) && !isNaN(parseFloat(fat))) { foodDatabase.push({ name, unit: unit.toLowerCase(), calories: parseFloat(cal), protein: parseFloat(prot), carbs: parseFloat(carb), fat: parseFloat(fat) }); added++; } else { invalid.push(i + 1); } } else { invalid.push(i + 1); } }); if (added > 0) { el('bulk-import-data').value = ''; saveData(); updateUI(); closeModal(modals.bulk); let msg = `${added} food(s) imported.`; if (invalid.length > 0) msg += `\nFailed lines: ${invalid.join(', ')}.`; showAlert(msg); } else { showAlert('Import failed. Check format.'); } });
            foodDatabaseList.addEventListener('click', (e) => { if (e.target.classList.contains('delete-food-btn')) { const i = parseInt(e.target.dataset.index); foodDatabase.splice(i, 1); dailyLog = dailyLog.filter(l => l.foodIndex !== i).map(l => { if (l.foodIndex > i) l.foodIndex--; return l; }); saveData(); updateUI(); } });
            
            foodSelect.addEventListener('change', e => {
                const foodIndex = e.target.value;
                const unitSelect = el('log-unit-select');
                unitSelect.innerHTML = '';
                if (foodIndex !== '') {
                    const food = foodDatabase[foodIndex];
                    const customUnits = food.portions ? Object.keys(food.portions) : [];
                    [...new Set([...customUnits, food.unit])].forEach(unit => {
                        const option = document.createElement('option');
                        option.value = unit;
                        option.textContent = unit;
                        unitSelect.appendChild(option);
                    });
                }
            });
            logFoodForm.addEventListener('submit', (e) => { 
                e.preventDefault(); 
                const foodIndex = foodSelect.value;
                const quantity = parseFloat(el('log-quantity').value);
                const unit = el('log-unit-select').value;

                if (foodIndex === '' || !quantity || quantity <= 0 || !unit) return showAlert('Please fill all fields to log food.');

                const food = foodDatabase[foodIndex];
                let amountInGramsOrMl;

                if (food.portions && food.portions[unit]) {
                    amountInGramsOrMl = quantity * food.portions[unit];
                } else {
                    amountInGramsOrMl = quantity;
                }

                dailyLog.push({ foodIndex: parseInt(foodIndex), amount: amountInGramsOrMl }); 
                saveData(); 
                updateUI(); 
                checkAchievements(); 
                logFoodForm.reset();
                el('log-unit-select').innerHTML = '';
            });

            dailyLogList.addEventListener('click', (e) => { if (e.target.classList.contains('delete-log-btn')) { dailyLog.splice(e.target.dataset.index, 1); saveData(); updateUI(); } });
            resetDayBtn.addEventListener('click', async () => { if (await showAlert(translations.resetConfirm[currentLang], [{ text: 'Cancel', resolvesTo: false }, { text: 'Reset', class: 'btn-danger', resolvesTo: true }])) { dailyLog = []; waterIntake = 0; saveData(); updateUI(); } });
            goalsForm.addEventListener('input', () => { Object.keys(dailyGoals).forEach(g => dailyGoals[g] = parseFloat(el(`goal-${g}`).value) || 0); saveData(); updateUI(); });
            adaptiveThemeToggle.addEventListener('change', (e) => { adaptiveThemeEnabled = e.target.checked; saveData(); applyTheme(); });
            el('export-data-btn').addEventListener('click', () => { const data = {}; for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); if (key.startsWith('dailyLog_') || ['foodDatabase', 'dailyGoals', 'adaptiveThemeEnabled', 'unlockedAchievements', 'customPortions', 'weightLog'].includes(key) || key.startsWith('waterIntake_')) data[key] = JSON.parse(localStorage.getItem(key)); } const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })); a.download = `nutrification-backup-${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(a.href); showAlert(translations.exportSuccessAlert[currentLang]); });
            el('import-data-btn').addEventListener('click', () => el('import-file-input').click());
            el('import-file-input').addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (event) => { try { const data = JSON.parse(event.target.result); if (await showAlert(translations.importConfirm[currentLang], [{ text: 'Cancel', resolvesTo: false }, { text: 'Import', class: 'btn-danger', resolvesTo: true }])) { Object.keys(data).forEach(key => localStorage.setItem(key, JSON.stringify(data[key]))); init(); showAlert(translations.importSuccessAlert[currentLang]); } } catch (error) { showAlert(`Error importing file: ${error.message}`); } }; reader.readAsText(file); e.target.value = ''; });
            
            el('view-micros-btn').addEventListener('click', () => { renderMicrosModal(); openModal(modals.micros); });
            el('toggle-micros-btn').addEventListener('click', () => {
                const container = el('micros-inputs-container');
                container.classList.toggle('hidden');
                if(!container.classList.contains('hidden') && container.innerHTML === '') {
                    Object.keys(MICRONUTRIENTS).forEach(micro => {
                        const unit = MICRONUTRIENTS[micro];
                        container.innerHTML += `<div><label for="micro-${micro}" class="text-sm">${micro.replace('vitamin', 'Vit ')} (${unit})</label><input type="number" id="micro-${micro}" data-micro="${micro}" step="0.1" placeholder="0" class="!py-1"></div>`;
                    });
                }
            });
            el('add-new-portion-btn').addEventListener('click', () => {
                const name = el('new-portion-name').value.trim();
                const value = parseFloat(el('new-portion-value').value);
                if(name && value > 0) {
                    currentFoodPortions[name] = value;
                    renderCurrentPortions();
                    el('new-portion-name').value = '';
                    el('new-portion-value').value = '';
                }
            });
            
            waterTracker.addEventListener('click', e => {
                const glass = e.target.closest('.glass');
                if(glass) {
                    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    
                    waterIntake = parseInt(glass.dataset.index);
                    if(glass.classList.contains('filled') && waterIntake === document.querySelectorAll('.glass.filled').length) {
                         waterIntake--;
                    }
                    
                    playPlopSound();
                    saveData();
                    renderWaterTracker();
                }
            });
            
            logWeightBtn.addEventListener('click', () => openModal(modals.weight));
            el('log-weight-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const weight = parseFloat(el('weight-input').value);
                if(weight > 0) {
                    const dateKey = new Date().toISOString().split('T')[0];
                    weightLog[dateKey] = weight;
                    saveData();
                    updateUI();
                    closeModal(modals.weight);
                }
            });
            
            prevMonthBtn.addEventListener('click', () => {
                currentlyViewedDate.setMonth(currentlyViewedDate.getMonth() - 1);
                updateUI();
            });
            nextMonthBtn.addEventListener('click', () => {
                currentlyViewedDate.setMonth(currentlyViewedDate.getMonth() + 1);
                updateUI();
            });

            function renderCurrentPortions() {
                const container = el('new-food-portions-container');
                container.innerHTML = '';
                Object.keys(currentFoodPortions).forEach(name => {
                    const value = currentFoodPortions[name];
                    container.innerHTML += `<div class="text-sm bg-gray-100 p-2 rounded flex justify-between"><span>1 ${name} = ${value}${el('food-unit').value}</span><button type="button" data-name="${name}" class="text-red-500 font-bold delete-portion-btn">X</button></div>`;
                });
            }

            el('new-food-portions-container').addEventListener('click', e => {
                if(e.target.classList.contains('delete-portion-btn')) {
                    delete currentFoodPortions[e.target.dataset.name];
                    renderCurrentPortions();
                }
            });
            
            const init = () => {
                loadData();
                updateUI();
            };
            init();
        });
    </script>
</body>
</html>

